<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>당번 정하기 시스템 Ver1.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-bg: #1a1d21;
            --secondary-bg: #2c2f34;
            --card-bg: #2a2d32;
            --accent-color: #4a90e2;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --info-color: #17a2b8;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            max-width: 800px;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            text-align: center;
        }

        .metal-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .metal-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-metal {
            background: linear-gradient(145deg, #3a3d42, #2a2d32);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 100px;
            height: min-content;
            align-self: center;
        }

        .btn-metal:hover {
            background: linear-gradient(145deg, #4a4d52, #3a3d42);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            border: none;
            border-radius: 8px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 15px;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        .date-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .date-card.today {
            background: linear-gradient(145deg, #2a2d32, #1a1d21);
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.4);
            transform: scale(1.02);
        }

        .date-card.today .date-title {
            color: var(--accent-color);
            font-weight: 700;
        }

        .date-card.today:hover {
            transform: scale(1.03);
            box-shadow: 0 0 25px rgba(74, 144, 226, 0.5);
        }

        .date-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .date-title.mb-0 {
            margin-right: 20px;
        }

        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .duty-button {
            min-width: 60px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .cancel-btn {
            color: #000 !important;
            font-weight: bold;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-controls {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.2);
        }

        .admin-title {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .nickname-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 15px;
            flex: 1;
        }

        .nickname-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .admin-buttons .btn {
            flex: 1;
        }

        .btn-info {
            background: var(--info-color);
            border: none;
            border-radius: 8px;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            color: white;
        }

        .save-btn {
            background: linear-gradient(145deg, #4a90e2, #357abd);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 140px;
            font-size: 1.1em;
        }

        .save-btn:hover {
            background: linear-gradient(145deg, #357abd, #2a5f94);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .save-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title mb-0">당번 정하기 시스템 Ver1.1</h1>
        <div>
            <button class="btn btn-metal" onclick="adminLogin()" id="adminLoginBtn">관리자 로그인</button>
            <button class="btn btn-metal" onclick="adminLogout()" id="adminLogoutBtn" style="display:none;">관리자 로그아웃</button>
        </div>
    </div>
    
    <div class="metal-card">
        <div class="d-flex gap-3">
            <input type="text" id="nickname" class="form-control nickname-input" placeholder="닉네임 입력">
            <button class="save-btn" onclick="saveNickname()">저장하기</button>
        </div>
    </div>

    <div class="metal-card admin-controls" id="adminControls" style="display:none;">
        <h5 class="admin-title">날짜 오픈 설정</h5>
        <input type="date" id="startDate" class="form-control my-2">
        <input type="date" id="endDate" class="form-control my-2">
        <input type="number" id="maxParticipants" class="form-control my-2" placeholder="일일 최대 인원">
        <div class="admin-buttons">
            <button class="btn btn-metal" onclick="openDates()">오픈하기</button>
            <button class="btn btn-info" onclick="resetDuty()">당번 초기화</button>
            <button class="btn btn-danger" onclick="resetAll()">전체 초기화</button>
        </div>
        <hr class="my-3" style="border-color: rgba(255,255,255,0.1);">
        <h5 class="admin-title">전체 시간 설정</h5>
        <div class="d-flex gap-2">
            <input type="time" id="globalTime" class="form-control my-2" placeholder="전체 시간 입력">
            <button class="btn btn-metal" onclick="saveGlobalTime()" style="min-width: 140px;">전체 시간 저장</button>
        </div>
    </div>

    <div id="dateList" class="my-4"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAY6Ff6uZ-iZ7soeuXBU0mtTKKZZ8gAPck",
        authDomain: "bossraidtracker.firebaseapp.com",
        databaseURL: "https://bossraidtracker-default-rtdb.firebaseio.com",
        projectId: "bossraidtracker",
        storageBucket: "bossraidtracker.appspot.com",
        messagingSenderId: "975753692062",
        appId: "1:975753692062:web:0991fb5bcbc52a9d3d0c8f",
        measurementId: "G-MC8YY38ZP3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // 참고: 기존 데이터와 충돌하지 않도록 새로운 경로(duty_selector/...)를 사용합니다.
    // 예: db.ref("duty_selector/dates/...") 또는 db.ref("duty_selector/participants/...")

    // 날짜 표시 함수
    function displayDates(dutyData) {
        const dateList = document.getElementById("dateList");
        dateList.innerHTML = "";
        const currentNickname = document.getElementById("nickname").value;
        const isAdmin = localStorage.getItem('duty_selector_admin') === 'true';
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let dt = new Date(dutyData.startDate); dt <= new Date(dutyData.endDate); dt.setDate(dt.getDate() + 1)) {
            const day = new Date(dt);
            const card = document.createElement("div");
            card.className = "date-card";
            const isToday = day.getFullYear() === today.getFullYear() && 
                            day.getMonth() === today.getMonth() && 
                            day.getDate() === today.getDate();
            if (isToday) card.classList.add('today');
            const dateText = day.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            const dateKey = day.toISOString().split('T')[0];

            db.ref(`duty_selector/times/${dateKey}`).once('value').then((timeSnap) => {
                const savedTime = timeSnap.val();
                let timeHtml = '';
                if (isAdmin) {
                    timeHtml = `<div class="d-flex gap-2"><input type="time" id="timeInput_${dateKey}" class="form-control my-2" placeholder="시간 입력"${savedTime ? ` value="${savedTime}"` : ''}><button class="btn btn-metal" onclick="saveTime('${dateKey}')">시간 저장</button></div>`;
                } else if (savedTime) {
                    timeHtml = `<span class="badge bg-info text-dark ms-2">당번 타임 ${savedTime}</span>`;
                }
                card.innerHTML = `<div class="d-flex align-items-center"><div class="date-title mb-0">${dateText}</div>${timeHtml}</div><div class="buttons-container"></div>`;

                // 참가자 정보 표시
                const participantsRef = db.ref(`duty_selector/participants/${dateKey}`);
                participantsRef.on('value', (snapshot) => {
                    const participants = snapshot.val() || {};
                    const buttonsContainer = card.querySelector('.buttons-container') || document.createElement('div');
                    buttonsContainer.className = 'buttons-container d-flex flex-wrap gap-1 mt-2';
                    buttonsContainer.innerHTML = '';
                    for (let i = 0; i < dutyData.maxParticipants; i++) {
                        const buttonGroup = document.createElement("div");
                        buttonGroup.className = "d-flex gap-1";
                        const btn = document.createElement("button");
                        btn.className = "btn btn-metal btn-sm duty-button";
                        if (participants[i]) {
                            btn.innerHTML = participants[i].nickname;
                            btn.disabled = true;
                            if (isAdmin || participants[i].nickname === currentNickname) {
                                const cancelBtn = document.createElement("button");
                                cancelBtn.className = "btn btn-danger btn-sm cancel-btn";
                                cancelBtn.innerHTML = "X";
                                cancelBtn.onclick = function() {
                                    if (confirm('정말로 취소하시겠습니까?')) {
                                        participantsRef.child(i).remove()
                                            .then(() => {
                                                btn.innerHTML = "+";
                                                btn.disabled = false;
                                                this.remove();
                                            })
                                            .catch((error) => {
                                                console.error('Error removing participant:', error);
                                                alert('취소 중 오류가 발생했습니다.');
                                            });
                                    }
                                };
                                buttonGroup.appendChild(btn);
                                buttonGroup.appendChild(cancelBtn);
                            } else {
                                buttonGroup.appendChild(btn);
                            }
                        } else {
                            btn.innerHTML = "+";
                            btn.onclick = function() {
                                const nickname = document.getElementById("nickname").value;
                                if (!nickname) {
                                    alert("닉네임을 입력하세요.");
                                    return;
                                }
                                participantsRef.once('value')
                                    .then((snapshot) => {
                                        const currentParticipants = snapshot.val() || {};
                                        for (const key in currentParticipants) {
                                            if (currentParticipants[key].nickname === nickname) {
                                                alert('이미 다른 날짜에 등록된 닉네임입니다.');
                                                return;
                                            }
                                        }
                                        db.ref('duty_selector/participants').once('value')
                                            .then((allSnapshot) => {
                                                const allParticipants = allSnapshot.val() || {};
                                                for (const date in allParticipants) {
                                                    for (const key in allParticipants[date]) {
                                                        if (allParticipants[date][key].nickname === nickname) {
                                                            alert('이미 다른 날짜에 등록된 닉네임입니다.');
                                                            return;
                                                        }
                                                    }
                                                }
                                                if (currentParticipants[i]) {
                                                    alert('이미 다른 사용자가 선택했습니다.');
                                                    return;
                                                }
                                                const participantData = {
                                                    nickname: nickname,
                                                    timestamp: Date.now()
                                                };
                                                participantsRef.child(i).set(participantData)
                                                    .then(() => {
                                                        btn.innerHTML = nickname;
                                                        btn.disabled = true;
                                                        if (isAdmin || nickname === currentNickname) {
                                                            const cancelBtn = document.createElement("button");
                                                            cancelBtn.className = "btn btn-danger btn-sm cancel-btn";
                                                            cancelBtn.innerHTML = "X";
                                                            cancelBtn.onclick = function() {
                                                                if (confirm('정말로 취소하시겠습니까?')) {
                                                                    participantsRef.child(i).remove()
                                                                        .then(() => {
                                                                            btn.innerHTML = "+";
                                                                            btn.disabled = false;
                                                                            this.remove();
                                                                        })
                                                                        .catch((error) => {
                                                                            console.error('Error removing participant:', error);
                                                                            alert('취소 중 오류가 발생했습니다.');
                                                                        });
                                                                }
                                                            };
                                                            buttonGroup.appendChild(cancelBtn);
                                                        }
                                                    })
                                                    .catch((error) => {
                                                        console.error('Error saving participant:', error);
                                                        alert('저장 중 오류가 발생했습니다.');
                                                    });
                                            });
                                    });
                            };
                            buttonGroup.appendChild(btn);
                        }
                        buttonsContainer.appendChild(buttonGroup);
                    }
                    if (!card.querySelector('.buttons-container')) {
                        card.appendChild(buttonsContainer);
                    }
                });
                dateList.appendChild(card);
            });
        }
    }

    // 관리자 로그인 함수
    function adminLogin() {
        const id = prompt("아이디 입력:");
        const pw = prompt("비밀번호 입력:");
        if (id === "dogfightda@gmail.com" && pw === "0716") {
            localStorage.setItem('duty_selector_admin', 'true');
            document.getElementById("adminControls").style.display = "block";
            document.getElementById("adminLoginBtn").style.display = "none";
            document.getElementById("adminLogoutBtn").style.display = "inline-block";
            alert("관리자 로그인 성공!");
            location.reload(); // 페이지 새로고침
        } else {
            alert("로그인 실패");
        }
    }

    // 관리자 로그아웃 함수
    function adminLogout() {
        localStorage.removeItem('duty_selector_admin');
        document.getElementById("adminControls").style.display = "none";
        document.getElementById("adminLoginBtn").style.display = "inline-block";
        document.getElementById("adminLogoutBtn").style.display = "none";
        alert("로그아웃 되었습니다.");
        location.reload(); // 페이지 새로고침
    }

    // 페이지 로드 시 저장된 설정 불러오기
    document.addEventListener('DOMContentLoaded', function() {
        // 저장된 닉네임 불러오기
        const savedNickname = localStorage.getItem('duty_selector_nickname');
        if (savedNickname) {
            document.getElementById('nickname').value = savedNickname;
        }
        
        // 관리자 상태 확인
        const isAdmin = localStorage.getItem('duty_selector_admin') === 'true';
        if (isAdmin) {
            document.getElementById("adminControls").style.display = "block";
            document.getElementById("adminLoginBtn").style.display = "none";
            document.getElementById("adminLogoutBtn").style.display = "inline-block";
        } else {
            document.getElementById("adminControls").style.display = "none";
            document.getElementById("adminLoginBtn").style.display = "inline-block";
            document.getElementById("adminLogoutBtn").style.display = "none";
        }

        // 실시간으로 설정 데이터 감시
        db.ref('duty_selector/settings').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // 관리자인 경우 입력 필드에 값 설정
                if (isAdmin) {
                    document.getElementById("startDate").value = new Date(data.startDate).toISOString().split('T')[0];
                    document.getElementById("endDate").value = new Date(data.endDate).toISOString().split('T')[0];
                    document.getElementById("maxParticipants").value = data.maxParticipants;
                }
                // 화면에 표시
                displayDates(data);
            } else {
                // 데이터가 없는 경우 날짜 목록 초기화
                document.getElementById("dateList").innerHTML = "";
                if (isAdmin) {
                    document.getElementById("startDate").value = "";
                    document.getElementById("endDate").value = "";
                    document.getElementById("maxParticipants").value = "";
                }
            }
        });
    });

    // 닉네임 저장 함수
    function saveNickname() {
        const nickname = document.getElementById('nickname').value.trim();
        if (!nickname) {
            alert('닉네임을 입력해주세요.');
            return;
        }
        localStorage.setItem('duty_selector_nickname', nickname);
        alert('닉네임이 저장되었습니다.');
    }

    function openDates() {
        const start = new Date(document.getElementById("startDate").value);
        const end = new Date(document.getElementById("endDate").value);
        const max = document.getElementById("maxParticipants").value;
        const timeInputs = document.querySelectorAll('input[type="time"]');
        const times = Array.from(timeInputs).map(input => input.value);

        if (!start || !end || !max || times.some(time => !time)) {
            alert('모든 필드를 입력해주세요.');
            return;
        }

        // 파이어베이스에 저장할 데이터 구조
        const dutyData = {
            startDate: start.getTime(),
            endDate: end.getTime(),
            maxParticipants: parseInt(max),
            times: times,
            createdAt: Date.now()
        };

        // 파이어베이스에 저장
        db.ref('duty_selector/settings').set(dutyData)
            .then(() => {
                alert('날짜 오픈 설정이 저장되었습니다.');
                displayDates(dutyData); // 화면에 표시
            })
            .catch((error) => {
                console.error('Error saving data:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
    }

    // 초기화 함수
    function resetDuty() {
        if (!confirm('정말로 모든 당번 정보를 초기화하시겠습니까?')) {
            return;
        }

        // 파이어베이스에서 모든 당번 정보 삭제
        db.ref('duty_selector/participants').remove()
            .then(() => {
                alert('모든 당번 정보가 초기화되었습니다.');
                // 현재 설정으로 화면 새로고침
                db.ref('duty_selector/settings').once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            displayDates(data);
                        }
                    });
            })
            .catch((error) => {
                console.error('Error resetting data:', error);
                alert('초기화 중 오류가 발생했습니다.');
            });
    }

    // 전체 초기화 함수
    function resetAll() {
        if (!confirm('정말로 모든 설정과 당번 정보를 초기화하시겠습니까?\n날짜 설정과 당번 정보가 모두 삭제됩니다.')) {
            return;
        }

        // 파이어베이스에서 모든 데이터 삭제
        db.ref('duty_selector').remove()
            .then(() => {
                // 입력 필드 초기화
                document.getElementById("startDate").value = "";
                document.getElementById("endDate").value = "";
                document.getElementById("maxParticipants").value = "";
                // 날짜 목록 초기화
                document.getElementById("dateList").innerHTML = "";
                alert('모든 설정과 당번 정보가 초기화되었습니다.');
            })
            .catch((error) => {
                console.error('Error resetting all data:', error);
                alert('초기화 중 오류가 발생했습니다.');
            });
    }

    function saveTime(dateKey) {
        const timeInput = document.getElementById('timeInput_' + dateKey);
        const time = timeInput.value;
        if (!time) {
            alert('시간을 입력해주세요.');
            return;
        }
        db.ref(`duty_selector/times/${dateKey}`).set(time)
            .then(() => { alert('시간이 저장되었습니다.'); })
            .catch((error) => {
                console.error('Error saving time:', error);
                alert('저장 중 오류가 발생했습니다.');
            });
    }

    function saveGlobalTime() {
        const globalTime = document.getElementById('globalTime').value;
        if (!globalTime) {
            alert('시간을 입력해주세요.');
            return;
        }

        // 현재 설정된 날짜 범위 가져오기
        db.ref('duty_selector/settings').once('value')
            .then((snapshot) => {
                const settings = snapshot.val();
                if (!settings) {
                    alert('먼저 날짜를 설정해주세요.');
                    return;
                }

                const startDate = new Date(settings.startDate);
                const endDate = new Date(settings.endDate);
                const promises = [];

                // 모든 날짜에 대해 시간 설정
                for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                    const dateKey = dt.toISOString().split('T')[0];
                    promises.push(db.ref(`duty_selector/times/${dateKey}`).set(globalTime));
                }

                // 모든 시간 설정이 완료되면 알림
                Promise.all(promises)
                    .then(() => {
                        alert('모든 날짜의 시간이 설정되었습니다.');
                        // 화면 새로고침
                        displayDates(settings);
                    })
                    .catch((error) => {
                        console.error('Error saving global time:', error);
                        alert('시간 설정 중 오류가 발생했습니다.');
                    });
            })
            .catch((error) => {
                console.error('Error getting settings:', error);
                alert('설정을 불러오는 중 오류가 발생했습니다.');
            });
    }
</script>

</body>
</html>
